<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>âœ¨å½¬â€™så°ˆå±¬ç´…åŒ…ğŸ§§ğŸ’</title>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background-color: #8b0000; touch-action: none; font-family: "Microsoft JhengHei", sans-serif; }
        canvas { display: block; }
        
        #intro { position: absolute; top: 10%; left: 50%; transform: translateX(-50%); color: #ffd700; font-size: 22px; font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); text-align: center; z-index: 5; width: 90%; pointer-events: none; }

        /* ä¸­çå°è©±æ¡†æ¨£å¼ */
        #resultModal {
            display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.5);
            width: 80%; max-width: 320px; background: #fff8e7; border: 4px solid #ffd700;
            border-radius: 20px; padding: 30px 20px; text-align: center; z-index: 200;
            box-shadow: 0 0 30px rgba(0,0,0,0.6); transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            opacity: 0;
        }
        #resultModal.show { display: block; transform: translate(-50%, -50%) scale(1); opacity: 1; }
        #resultTitle { color: #d90000; font-size: 22px; margin-bottom: 10px; font-weight: bold; }
        #resultText { color: #333; font-size: 20px; line-height: 1.6; margin-bottom: 20px; white-space: pre-wrap; }
        #closeModalBtn {
            background: #d90000; color: white; border: none; padding: 12px 30px;
            font-size: 18px; border-radius: 50px; cursor: pointer; font-weight: bold;
        }

        /* åŠ å¤§å¾Œçš„ LINE æŒ‰éˆ• */
        #shareBtn {
            display: none; position: absolute; bottom: 60px; left: 50%; transform: translateX(-50%);
            background-color: #06C755; color: white; border: none; 
            padding: 18px 45px; 
            font-size: 22px; 
            border-radius: 50px; box-shadow: 0 6px 20px rgba(0,0,0,0.5);
            cursor: pointer; z-index: 100; font-weight: bold; width: 80%; max-width: 300px;
        }
    </style>
</head>
<body>

<div id="intro">âœ¨å½¬â€™så°ˆå±¬ç´…åŒ…ğŸ§§ğŸ’</div>

<div id="resultModal">
    <div id="resultTitle">æ­å–œæŠ½ä¸­ï¼</div>
    <div id="resultText"></div>
    <button id="closeModalBtn" onclick="hideModal()">æ”¶ä¸‹ç´…åŒ…</button>
</div>

<button id="shareBtn" onclick="shareToLine()">å‚³é€çµæœçµ¦å°æ–¹</button>
<canvas id="gameCanvas"></canvas>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const shareBtn = document.getElementById('shareBtn');
    const resultModal = document.getElementById('resultModal');
    const resultText = document.getElementById('resultText');
    
    const urlParams = new URLSearchParams(window.location.search);
    let senderName = urlParams.get('from'); 

    const prizeMap = {
        "0000": { name: "ğŸ˜ ç²¾ç¥æ”¯æŒç", detail: "\nğŸ˜“", val: "$0000" },
        "1111": { name: "ğŸ§¸ è¶…ç´šå¹¸é‹æ˜Ÿ", detail: "", val: "$1111" },
        "2222": { name: "ğŸ‘‘ å°ˆå±¬ç´…åˆ©", detail: "", val: "$2222" },
        "888": { name: "ğŸ† è¶…ç´šå¤§ç¦®åŒ…", detail: "", val: "$888" },
        "666": { name: "ğŸ”¥ å¿ƒè·³æš´æ“ŠåŒ…", detail: "", val: "$666" },
        "520": { name: "â¤ï¸ æˆ‘çš„æ„›\nï¼ˆé™å®šç‰ˆï¼‰", detail: "", val: "$520" },
        "222": { name: "ğŸ’ åªå°ä½ æœ‰æ•ˆ", detail: "", val: "$222" },
        "0816": { name: "ğŸ‘©ğŸ»â€â¤ï¸â€ğŸ‘¨ğŸ» å°ˆå±¬å›æ†¶", detail: "", val: "$816" },
        "88": { name: "ğŸ«¶ æŠ±æŠ±å„²å€¼å¡", detail: "", val: "$888" },
        "ä¸€å€‹é£›å»": { name: "ğŸ’‹ è¦ªä¸€ä¸‹", detail: "", val: "ä¸€å€‹é£›å»ğŸ˜˜" },
        "1002": { name: "ğŸš¢ èˆªæµ·ç´…åŒ…", detail: "", val: "$1002" },
        "éŠ˜è¬æƒ é¡§": { name: "ğŸ¥² ä¸‹æ¬¡å†å¯µä½ åˆ¸", detail: "", val: "éŠ˜è¬æƒ é¡§" }
    };

    const prizeKeys = Object.keys(prizeMap);
    let boxes = [], particles = [], lastPrize = null;

    function init() {
        resize();
        window.addEventListener('resize', resize);
        canvas.addEventListener('click', (e) => handleInput(e.clientX, e.clientY));
        canvas.addEventListener('touchstart', (e) => {
            if(e.target.tagName === 'BUTTON') return;
            handleInput(e.touches[0].clientX, e.touches[0].clientY);
        }, {passive: false});
        createBoxes([...prizeKeys].sort(() => Math.random() - 0.5));
        loop();
    }

    function resize() {
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        if (boxes.length > 0) recalcPositions();
    }

    function createBoxes(prizes) {
        const cols = 3, rows = 4;
        const boxW = (canvas.width * 0.9) / cols, boxH = (canvas.height * 0.6) / rows;
        for (let i = 0; i < 12; i++) {
            boxes.push({ r: Math.floor(i/3), c: i%3, key: prizes[i], isOpen: false, w: boxW * 0.82, h: boxH * 0.8 });
        }
        recalcPositions();
    }

    function recalcPositions() {
        const marginX = canvas.width * 0.05, marginY = canvas.height * 0.18;
        const boxW = (canvas.width * 0.9) / 3, boxH = (canvas.height * 0.6) / 4;
        boxes.forEach(b => {
            b.cx = marginX + (b.c * boxW) + (boxW/2);
            b.cy = marginY + (b.r * boxH) + (boxH/2);
            b.x = b.cx - b.w/2; b.y = b.cy - b.h/2;
        });
    }

    class Particle {
        constructor(x, y, color) {
            this.x = x; this.y = y; this.color = color;
            const angle = Math.random() * Math.PI * 2;
            const speed = Math.random() * 8 + 3;
            this.vx = Math.cos(angle) * speed;
            this.vy = Math.sin(angle) * speed;
            this.life = 1; this.decay = Math.random() * 0.01 + 0.008;
        }
        update() { this.x += this.vx; this.y += this.vy; this.vy += 0.1; this.life -= this.decay; }
        draw() {
            ctx.globalAlpha = this.life; ctx.fillStyle = this.color;
            ctx.beginPath(); ctx.arc(this.x, this.y, 3, 0, Math.PI*2); ctx.fill();
        }
    }

    function firework(x, y) {
        const colors = ['#FFD700', '#FF4500', '#FF69B4', '#00FFFF', '#ADFF2F'];
        const color = colors[Math.floor(Math.random()*colors.length)];
        for(let i=0; i<80; i++) particles.push(new Particle(x, y, color));
    }

    function handleInput(x, y) {
        boxes.forEach(b => {
            if (!b.isOpen && x > b.x && x < b.x + b.w && y > b.y && y < b.y + b.h) {
                b.isOpen = true; 
                lastPrize = prizeMap[b.key];
                if (window.navigator.vibrate) window.navigator.vibrate([100, 50, 100]);
                
                firework(canvas.width/2, canvas.height/3);
                setTimeout(() => firework(canvas.width*0.2, canvas.height*0.5), 300);
                setTimeout(() => firework(canvas.width*0.8, canvas.height*0.4), 600);

                setTimeout(() => showModal(lastPrize), 1500);
            }
        });
    }

    function showModal(prize) {
        // å½ˆè·³è¦–çª—ï¼šé¡¯ç¤ºé‡‘é¡ + åç¨±
        resultText.innerText = `${prize.val}\n${prize.name.replace('\n', '')}${prize.detail.trim()}`;
        resultModal.classList.add('show');
    }

    function hideModal() {
        resultModal.classList.remove('show');
        setTimeout(() => {
            resultModal.style.display = 'none';
            shareBtn.style.display = 'block';
        }, 300);
    }

    function shareToLine() {
        const baseUrl = window.location.href.split('?')[0]; 
        const lineText = senderName ? 
            `å˜¿ï¼${senderName}ï¼Œæˆ‘åœ¨ä½ åˆ†äº«çš„ç´…åŒ…æŠ½åˆ°äº†ï¼š\nã€${lastPrize.name.replace('\n', '')} - ${lastPrize.val}ã€‘ï¼âœ¨ğŸ§§` : 
            `æˆ‘åœ¨ã€Œå½¬â€™så°ˆå±¬ç´…åŒ…ã€ä¸­æŠ½åˆ°äº†ï¼š\nã€${lastPrize.name.replace('\n', '')} - ${lastPrize.val}ã€‘ï¼ğŸ§§\nä½ ä¹Ÿä¾†æŠ½ï¼š\n${baseUrl}`;
        window.location.href = `https://line.me/R/msg/text/?${encodeURIComponent(lineText)}`;
    }

    function drawBackground() {
        ctx.fillStyle = '#8B0000'; ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.strokeStyle = '#A52A2A'; ctx.lineWidth = 1.5;
        for (let y = 0; y < canvas.height; y += 60) {
            ctx.beginPath();
            for (let x = (y/60)%2*30; x < canvas.width + 60; x += 60) ctx.arc(x, y, 15, 0, Math.PI, true);
            ctx.stroke();
        }
    }

    function drawEnvelopes() {
        boxes.forEach(b => {
            ctx.save(); ctx.translate(b.cx, b.cy);
            if (!b.isOpen) {
                ctx.fillStyle = '#D90000'; ctx.fillRect(-b.w/2, -b.h/2, b.w, b.h);
                ctx.fillStyle = '#B30000'; ctx.beginPath(); ctx.moveTo(-b.w/2, -b.h/2);
                ctx.quadraticCurveTo(0, -b.h/2 + b.h*0.4, b.w/2, -b.h/2); ctx.fill();
                ctx.fillStyle = '#FFD700'; ctx.beginPath(); ctx.arc(0, 0, b.w*0.2, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = '#D90000'; ctx.font = `bold ${b.w*0.25}px serif`; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText('ç¦', 0, 0);
            } else {
                ctx.fillStyle = 'rgba(255, 248, 231, 0.9)'; ctx.fillRect(-b.w/2, -b.h/2, b.w, b.h);
                ctx.strokeStyle = '#FFD700'; ctx.lineWidth = 3; ctx.strokeRect(-b.w/2, -b.h/2, b.w, b.h);
                ctx.fillStyle = '#D90000';
                
                const p = prizeMap[b.key];
                const lines = p.name.split('\n');
                
                // å‹•æ…‹å­—é«”å¤§å°èª¿æ•´
                let fontSize = b.w * 0.14;
                if (p.name.length > 6) fontSize = b.w * 0.12;
                
                ctx.font = `bold ${fontSize}px Arial`;
                ctx.textAlign='center'; ctx.textBaseline='middle';

                // ç´…åŒ…æ ¼å­å…§åªé¡¯ç¤ºä¸­æ–‡å­—åç¨±
                if(lines.length === 1) {
                    ctx.fillText(lines[0], 0, 0);
                } else {
                    ctx.fillText(lines[0], 0, -fontSize * 0.6);
                    ctx.fillText(lines[1], 0, fontSize * 0.6);
                }
            }
            ctx.restore();
        });
    }

    function loop() {
        drawBackground(); drawEnvelopes();
        for(let i = particles.length - 1; i >= 0; i--) {
            particles[i].update(); particles[i].draw();
            if(particles[i].life <= 0) particles.splice(i, 1);
        }
        requestAnimationFrame(loop);
    }

    init();
</script>
</body>
</html>
