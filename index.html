<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ§§ æ–°æ˜¥ç´…åŒ…æŠ½æŠ½æ¨‚</title>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background-color: #8b0000; touch-action: none; font-family: "Microsoft JhengHei", sans-serif; }
        canvas { display: block; }
        #intro { position: absolute; top: 15%; left: 50%; transform: translateX(-50%); color: #ffd700; font-size: 22px; font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); text-align: center; z-index: 10; width: 90%; pointer-events: none; }
        
        #shareBtn {
            display: none; position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%);
            background-color: #06C755; color: white; border: none; padding: 15px 30px;
            font-size: 18px; border-radius: 50px; box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            cursor: pointer; z-index: 20; font-weight: bold;
        }
    </style>
</head>
<body>

<div id="intro">ğŸ§§ é»æ“Šç´…åŒ…è©¦è©¦æ‰‹æ°£ ğŸ§§</div>
<button id="shareBtn" onclick="shareToLine()">å‚³é€çµæœçµ¦å°æ–¹</button>
<canvas id="gameCanvas"></canvas>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const shareBtn = document.getElementById('shareBtn');
    const introDiv = document.getElementById('intro');
    
    const urlParams = new URLSearchParams(window.location.search);
    let senderName = urlParams.get('from'); 

    const prizesSource = ['000', '1111', '2222', '666', '222', '111', '88', '888', '66', '6', '8', '87'];
    let boxes = [], particles = [], lastPrize = "";

    function init() {
        resize();
        window.addEventListener('resize', resize);
        
        canvas.addEventListener('click', (e) => handleInput(e.clientX, e.clientY));
        canvas.addEventListener('touchstart', (e) => {
            if(e.target.id === 'shareBtn') return;
            e.preventDefault();
            handleInput(e.touches[0].clientX, e.touches[0].clientY);
        }, {passive: false});

        createBoxes([...prizesSource].sort(() => Math.random() - 0.5));
        loop();
    }

    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        if (boxes.length > 0) recalcPositions();
    }

    function createBoxes(prizes) {
        const cols = 3, rows = 4;
        const boxW = (canvas.width * 0.9) / cols, boxH = (canvas.height * 0.7) / rows;
        for (let i = 0; i < 12; i++) {
            boxes.push({ r: Math.floor(i/3), c: i%3, prize: prizes[i], isOpen: false, scale: 1, w: boxW * 0.85, h: boxH * 0.8 });
        }
        recalcPositions();
    }

    function recalcPositions() {
        const marginX = canvas.width * 0.05, marginY = canvas.height * 0.2;
        const boxW = (canvas.width * 0.9) / 3, boxH = (canvas.height * 0.7) / 4;
        boxes.forEach(b => {
            b.cx = marginX + (b.c * boxW) + (boxW/2);
            b.cy = marginY + (b.r * boxH) + (boxH/2);
            b.x = b.cx - b.w/2; b.y = b.cy - b.h/2;
        });
    }

    function shareToLine() {
        const baseUrl = window.location.href.split('?')[0]; 
        let text = senderName ? 
            `å˜¿ï¼${senderName}ï¼Œæˆ‘åœ¨ä½ åˆ†äº«çš„ç´…åŒ…éŠæˆ²æŠ½åˆ°äº†æ•¸å­—ï¼šã€${lastPrize}ã€‘ï¼ğŸ§§âœ¨` : 
            `æˆ‘åœ¨æ–°æ˜¥ç´…åŒ…éŠæˆ²ä¸­æŠ½åˆ°äº†ï¼šã€${lastPrize}ã€‘ï¼ğŸ§§\nä½ ä¹Ÿä¾†ç©ç©çœ‹å§ï¼š\n${baseUrl}`;
        
        window.location.href = `https://line.me/R/msg/text/?${encodeURIComponent(text)}`;
    }

    function handleInput(x, y) {
        boxes.forEach(b => {
            if (!b.isOpen && x > b.x && x < b.x + b.w && y > b.y && y < b.y + b.h) {
                b.isOpen = true; 
                lastPrize = b.prize;
                introDiv.style.opacity = '0';
                shareBtn.style.display = 'block';
                
                // --- éœ‡å‹•ç¨‹å¼ç¢¼ ---
                if (window.navigator && window.navigator.vibrate) {
                    window.navigator.vibrate(100); // éœ‡å‹• 100 æ¯«ç§’
                }
                
                for(let i=0; i<30; i++) particles.push({ x, y, vx: Math.random()*6-3, vy: Math.random()*6-3, life: 1, c: `hsl(${Math.random()*40+40},100%,50%)` });
            }
        });
    }

    function drawBackground() {
        ctx.fillStyle = '#8B0000'; ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.strokeStyle = '#A52A2A'; ctx.lineWidth = 2;
        for (let y = 0; y < canvas.height; y += 80) {
            ctx.beginPath();
            for (let x = (y/80)%2*40; x < canvas.width + 80; x += 80) ctx.arc(x, y, 20, 0, Math.PI, true);
            ctx.stroke();
        }
    }

    function drawEnvelopes() {
        boxes.forEach(b => {
            ctx.save(); ctx.translate(b.cx, b.cy); ctx.scale(b.scale, b.scale); ctx.translate(-b.cx, -b.cy);
            if (!b.isOpen) {
                ctx.fillStyle = '#D90000'; ctx.fillRect(b.x, b.y, b.w, b.h);
                ctx.fillStyle = '#B30000'; ctx.beginPath(); ctx.moveTo(b.x, b.y);
                ctx.quadraticCurveTo(b.cx, b.y + b.h*0.4, b.x+b.w, b.y); ctx.fill();
                ctx.fillStyle = '#FFD700'; ctx.beginPath(); ctx.arc(b.cx, b.cy, b.w*0.2, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = '#D90000'; ctx.font = `bold ${b.w*0.25}px serif`; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText('ç¦', b.cx, b.cy);
            } else {
                ctx.fillStyle = '#FFF8E7'; ctx.fillRect(b.x, b.y, b.w, b.h);
                ctx.strokeStyle = '#FFD700'; ctx.lineWidth = 4; ctx.strokeRect(b.x, b.y, b.w, b.h);
                ctx.fillStyle = '#D90000'; ctx.font = `bold ${b.w*0.3}px Arial`; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(b.prize, b.cx, b.cy);
            }
            ctx.restore();
        });
    }

    function loop() {
        drawBackground(); drawEnvelopes();
        particles.forEach((p, i) => {
            p.x += p.vx; p.y += p.vy; p.vy += 0.15; p.life -= 0.02;
            ctx.globalAlpha = p.life; ctx.fillStyle = p.c; ctx.beginPath(); ctx.arc(p.x, p.y, 3, 0, Math.PI*2); ctx.fill();
            if(p.life <= 0) particles.splice(i, 1);
        });
        ctx.globalAlpha = 1; requestAnimationFrame(loop);
    }

    init();
</script>
</body>
</html>
