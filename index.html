<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ§§ å°ˆå±¬å¿ƒå‹•ç´…åŒ…æŠ½æŠ½æ¨‚</title>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background-color: #8b0000; touch-action: none; font-family: "Microsoft JhengHei", sans-serif; }
        canvas { display: block; }
        #intro { position: absolute; top: 12%; left: 50%; transform: translateX(-50%); color: #ffd700; font-size: 20px; font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); text-align: center; z-index: 10; width: 90%; pointer-events: none; line-height: 1.5; }
        
        #shareBtn {
            display: none; position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%);
            background-color: #06C755; color: white; border: none; padding: 15px 30px;
            font-size: 18px; border-radius: 50px; box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            cursor: pointer; z-index: 100; font-weight: bold;
        }
    </style>
</head>
<body>

<div id="intro">ğŸ§§ ä½ çš„å°ˆå±¬ç´…åŒ… ğŸ§§<br><span style="font-size:14px; color:#ffa500;">( æŠ½ä¸­ä¸€å€‹æœ€æ„›ä½ çš„çé … )</span></div>
<button id="shareBtn" onclick="shareToLine()">å‚³é€çµæœçµ¦å°æ–¹</button>
<canvas id="gameCanvas"></canvas>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const shareBtn = document.getElementById('shareBtn');
    const introDiv = document.getElementById('intro');
    
    const urlParams = new URLSearchParams(window.location.search);
    let senderName = urlParams.get('from'); 

    // çé …åç¨±å°æ‡‰è¡¨
    const prizeMap = {
        "000": "ğŸ˜ ç²¾ç¥æ”¯æŒç\nï¼ˆæ„›ä½ ä½†æ²’ç¾é‡‘ï¼‰",
        "1111": "ğŸ’ çµ‚èº«åˆç´„çé‡‘",
        "2222": "ğŸ‘‘ å…¬ä¸»å°ˆå±¬ç´…åˆ©",
        "888": "ğŸ† è¶…ç´šå¹¸é‹ä¸»è§’å…‰ç’°",
        "666": "ğŸ”¥ å¿ƒè·³æš´æ“ŠåŒ…",
        "520": "â¤ï¸ æˆ‘çš„æ„›ï¼ˆé™å®šç‰ˆï¼‰",
        "222": "ğŸ’ åªå°ä½ æœ‰æ•ˆ",
        "111": "ğŸ’“ å¿ƒå‹•å•Ÿå‹•é‡‘",
        "88": "ğŸ«¶ æŠ±æŠ±å„²å€¼å¡",
        "66": "ğŸ’‹ è¦ªä¸€ä¸‹è§£é–",
        "8": "ğŸŒŸ ä»Šæ—¥å¹¸é‹å€¼+1",
        "éŠ˜è¬æƒ é¡§": "ğŸ¥² ä¸‹æ¬¡å†å¯µä½ åˆ¸"
    };

    const prizeKeys = Object.keys(prizeMap);
    let boxes = [], particles = [], fireworks = [], lastPrizeText = "";

    function init() {
        resize();
        window.addEventListener('resize', resize);
        
        canvas.addEventListener('click', (e) => handleInput(e.clientX, e.clientY));
        canvas.addEventListener('touchstart', (e) => {
            if(e.target.id === 'shareBtn') return;
            handleInput(e.touches[0].clientX, e.touches[0].clientY);
        }, {passive: false});

        createBoxes([...prizeKeys].sort(() => Math.random() - 0.5));
        loop();
    }

    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        if (boxes.length > 0) recalcPositions();
    }

    function createBoxes(prizes) {
        const cols = 3, rows = 4;
        const boxW = (canvas.width * 0.9) / cols, boxH = (canvas.height * 0.65) / rows;
        for (let i = 0; i < 12; i++) {
            boxes.push({ r: Math.floor(i/3), c: i%3, prizeKey: prizes[i], isOpen: false, scale: 1, w: boxW * 0.82, h: boxH * 0.8 });
        }
        recalcPositions();
    }

    function recalcPositions() {
        const marginX = canvas.width * 0.05, marginY = canvas.height * 0.22;
        const boxW = (canvas.width * 0.9) / 3, boxH = (canvas.height * 0.65) / 4;
        boxes.forEach(b => {
            b.cx = marginX + (b.c * boxW) + (boxW/2);
            b.cy = marginY + (b.r * boxH) + (boxH/2);
            b.x = b.cx - b.w/2; b.y = b.cy - b.h/2;
        });
    }

    // --- å…¨è¢å¹•ç…™ç«ç²’å­ç³»çµ± ---
    class Particle {
        constructor(x, y, color) {
            this.x = x; this.y = y; this.color = color;
            const angle = Math.random() * Math.PI * 2;
            const speed = Math.random() * 8 + 2;
            this.vx = Math.cos(angle) * speed;
            this.vy = Math.sin(angle) * speed;
            this.life = 1; this.decay = Math.random() * 0.015 + 0.01;
        }
        update() { this.x += this.vx; this.y += this.vy; this.vy += 0.12; this.life -= this.decay; }
        draw() {
            ctx.globalAlpha = this.life; ctx.fillStyle = this.color;
            ctx.beginPath(); ctx.arc(this.x, this.y, 2.5, 0, Math.PI*2); ctx.fill();
        }
    }

    function createFireworkExplosion(x, y) {
        const colors = ['#FFD700', '#FF4500', '#FF69B4', '#00FFFF', '#ADFF2F'];
        const color = colors[Math.floor(Math.random()*colors.length)];
        for(let i=0; i<80; i++) particles.push(new Particle(x, y, color));
    }

    function shareToLine() {
        const baseUrl = window.location.href.split('?')[0]; 
        const lineText = senderName ? 
            `å˜¿ï¼${senderName}ï¼Œæˆ‘åœ¨ä½ åˆ†äº«çš„ç´…åŒ…æŠ½åˆ°äº†ï¼š\nã€${lastPrizeText.replace('\n', '')}ã€‘ï¼âœ¨ğŸ§§` : 
            `æˆ‘åœ¨æ–°æ˜¥ç´…åŒ…éŠæˆ²ä¸­æŠ½åˆ°äº†ï¼š\nã€${lastPrizeText.replace('\n', '')}ã€‘ï¼ğŸ§§\nä½ ä¹Ÿä¾†æŠ½æŠ½çœ‹ï¼š\n${baseUrl}`;
        window.location.href = `https://line.me/R/msg/text/?${encodeURIComponent(lineText)}`;
    }

    function handleInput(x, y) {
        boxes.forEach(b => {
            if (!b.isOpen && x > b.x && x < b.x + b.w && y > b.y && y < b.y + b.h) {
                b.isOpen = true; 
                lastPrizeText = prizeMap[b.prizeKey];
                introDiv.style.opacity = '0';
                shareBtn.style.display = 'block';
                
                if (window.navigator.vibrate) window.navigator.vibrate([100, 50, 100]); 
                
                // è§¸ç™¼å…¨è¢å¹•ç…™ç« (å¤šè™•çˆ†ç‚¸)
                createFireworkExplosion(canvas.width/2, canvas.height/3);
                setTimeout(() => createFireworkExplosion(canvas.width*0.2, canvas.height*0.5), 200);
                setTimeout(() => createFireworkExplosion(canvas.width*0.8, canvas.height*0.4), 400);
            }
        });
    }

    function drawBackground() {
        ctx.fillStyle = '#8B0000'; ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.strokeStyle = '#A52A2A'; ctx.lineWidth = 1.5;
        for (let y = 0; y < canvas.height; y += 60) {
            ctx.beginPath();
            for (let x = (y/60)%2*30; x < canvas.width + 60; x += 60) ctx.arc(x, y, 15, 0, Math.PI, true);
            ctx.stroke();
        }
    }

    function drawEnvelopes() {
        boxes.forEach(b => {
            ctx.save(); ctx.translate(b.cx, b.cy);
            if (!b.isOpen) {
                // æœªæ‰“é–‹çš„ç´…åŒ…
                ctx.fillStyle = '#D90000'; 
                ctx.fillRect(-b.w/2, -b.h/2, b.w, b.h);
                // å°å£
                ctx.fillStyle = '#B30000'; ctx.beginPath(); ctx.moveTo(-b.w/2, -b.h/2);
                ctx.quadraticCurveTo(0, -b.h/2 + b.h*0.4, b.w/2, -b.h/2); ctx.fill();
                // ç¦å­—
                ctx.fillStyle = '#FFD700'; ctx.beginPath(); ctx.arc(0, 0, b.w*0.2, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = '#D90000'; ctx.font = `bold ${b.w*0.22}px serif`; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText('ç¦', 0, 0);
            } else {
                // å·²æ‰“é–‹çš„é¡¯ç¤º (æ–‡å­—æ’ç‰ˆå„ªåŒ–)
                ctx.fillStyle = 'rgba(255, 248, 231, 0.95)';
                ctx.fillRect(-b.w/2, -b.h/2, b.w, b.h);
                ctx.strokeStyle = '#FFD700'; ctx.lineWidth = 3; ctx.strokeRect(-b.w/2, -b.h/2, b.w, b.h);
                
                ctx.fillStyle = '#D90000';
                const lines = prizeMap[b.prizeKey].split('\n');
                let fontSize = lines.length > 1 ? b.w * 0.16 : b.w * 0.2;
                ctx.font = `bold ${fontSize}px "Microsoft JhengHei"`;
                ctx.textAlign='center'; ctx.textBaseline='middle';
                if(lines.length === 1) {
                    ctx.fillText(lines[0], 0, 0);
                } else {
                    ctx.fillText(lines[0], 0, -fontSize/1.5);
                    ctx.fillText(lines[1], 0, fontSize/1.5);
                }
            }
            ctx.restore();
        });
    }

    function loop() {
        drawBackground();
        drawEnvelopes();
        
        // æ›´æ–°ä¸¦ç¹ªè£½ç…™ç«ç²’å­
        for(let i = particles.length - 1; i >= 0; i--) {
            particles[i].update();
            particles[i].draw();
            if(particles[i].life <= 0) particles.splice(i, 1);
        }
        
        ctx.globalAlpha = 1;
        requestAnimationFrame(loop);
    }

    init();
</script>
</body>
</html>
